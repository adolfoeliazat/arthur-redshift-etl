{
    "objects": [
        {
            "id": "Default",
            "name": "Default",
            "failureAndRerunMode": "CASCADE",
            "resourceRole": "DataPipelineDefaultResourceRole",
            "role": "DataPipelineDefaultRole",
            "pipelineLogUri": "s3://#{myS3Bucket}/#{myEtlEnvironment}/logs/",
            "region": "us-east-1",
            "schedule": {
                "ref": "ValidationSchedule"
            },
            "scheduleType": "cron"            
        },
        {
            "id": "ValidationSchedule",
            "name": "Run once",
            "type": "Schedule",
            "period": "1 days",
            "startDateTime": "2016-10-12T20:30:00",
            "occurrences": "1"
            
        },
        {
          "id" : "ArthurDriverEC2Resource",
          "type" : "Ec2Resource",
          "actionOnTaskFailure" : "terminate",
          "actionOnResourceFailure" : "retryAll",
          "maximumRetries" : "1",
          "instanceType" : "m1.medium",
          "securityGroupIds" : [
            "sg-ce48cbb4",
            "sg-86cae9fc"
          ],
          "subnetId": "subnet-6eb95d35",
          "associatePublicIpAddress": "true",
          "keyPair": "harrys-dw-cluster-key",
          "terminateAfter": "2 Hours"
        },
        {
          "id" : "CopyBootstrap",
          "runsOn": {"ref": "ArthurDriverEC2Resource"},
          "type" : "ShellCommandActivity",
          "command": "/usr/bin/aws s3 cp s3://#{myS3Bucket}/#{myEtlEnvironment}/bootstrap/bootstrap.sh /tmp/bootstrap.sh",
          "dependsOn": {
             "ref": "InstallDeps"
           }
        },
        {
          "id" : "Bootstrap",
          "runsOn": {"ref": "ArthurDriverEC2Resource"},
          "type" : "ShellCommandActivity",
          "command": "bash /tmp/bootstrap.sh #{myS3Bucket} #{myEtlEnvironment}",
          "dependsOn": {
            "ref": "CopyBootstrap"
          }
        },
        {
          "id" : "CopySchemas",
          "runsOn": {"ref": "ArthurDriverEC2Resource"},
          "type" : "ShellCommandActivity",
          "command": "/usr/bin/aws s3 cp s3://#{myS3Bucket}/#{myEtlEnvironment}/schemas/ schemas/ --recursive",
          "dependsOn": {
             "ref": "Bootstrap"
           }
        },
        {
          "id" : "ArthurDesign",
          "runsOn": {"ref": "ArthurDriverEC2Resource"},
          "type" : "ShellCommandActivity",
          "command" : "/tmp/redshift_etl/venv/bin/arthur.py --config /tmp/redshift_etl/config/ design",
          "dependsOn": {"ref": "CopySchemas"},
          "maximumRetries": "0"
        },
        {
          "id" : "CopyStagingConf",
          "runsOn": {"ref": "ArthurDriverEC2Resource"},
          "type" : "ShellCommandActivity",
          "command": "/usr/bin/aws s3 sync s3://#{myS3Bucket}/validation/config/ /tmp/redshift_etl/staging_config/",
          "dependsOn": {"ref": "ArthurDesign"}
        },
        {
          "id" : "StagingInitialize",
          "runsOn": {"ref": "ArthurDriverEC2Resource"},
          "type" : "ShellCommandActivity",
          "command" : "/tmp/redshift_etl/venv/bin/arthur.py --config /tmp/redshift_etl/staging_config/ initialize validation_pipeline",
          "dependsOn": {"ref": "CopyStagingConf"},
          "maximumRetries": "0"
        },
        {
          "id" : "StagingLoad",
          "runsOn": {"ref": "ArthurDriverEC2Resource"},
          "type" : "ShellCommandActivity",
          "command" : "/tmp/redshift_etl/venv/bin/arthur.py --config /tmp/redshift_etl/staging_config/ load --prefix #{myEtlEnvironment} --skip-copy",
          "dependsOn": {"ref": "StagingInitialize"},
          "maximumRetries": "0"
        },
        {
          "id" : "StagingValidate",
          "runsOn": {"ref": "ArthurDriverEC2Resource"},
          "type" : "ShellCommandActivity",
          "command" : "/tmp/redshift_etl/venv/bin/arthur.py --config /tmp/redshift_etl/staging_config/ validate --prefix #{myEtlEnvironment} --keep-going",
          "dependsOn": {"ref": "StagingLoad"},
          "maximumRetries": "0"
        },
        {
          "id" : "CheckArthurLog",
          "runsOn": {"ref": "ArthurDriverEC2Resource"},
          "type" : "ShellCommandActivity",
          "command" : "if grep -E \"(ERROR|WARNING.*(Old|disappeared|mismatch))\" arthur.log*; then exit 1; fi",
          "dependsOn": {"ref": "StagingValidate"},
          "maximumRetries": "0"
        }
    ],
    "parameters": [
        {
            "id": "myS3Bucket",
            "type": "String",
            "optional": "false",
            "description": "Name of S3 bucket",
            "watermark": "production",
            "helpText": "Pick the name of the data lake."
        },
        {
            "id": "myEtlEnvironment",
            "type": "String",
            "optional": "false",
            "description": "Name of ETL environment",
            "watermark": "production",
            "helpText": "Pick the name such as 'development' or your user name."
        }
    ],
    "values": {
        "myEtlEnvironment": "development",
        "myS3Bucket": "default_s3_bucket"
    }
}
